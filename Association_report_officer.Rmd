---
title: "Association Report"
author: "Will MacKenzie"
date: "02/04/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# install.packages("officer")
#install.packages("flextable")
#devtools::install_github("davidgohel/flextable")
require(officer)
require(dplyr)
require(flextable)
```

## R Markdown using officer package to create standardize report of associations in Word

The current code is copied from https://sciprincess.wordpress.com/2020/02/17/creating-ms-word-reports-using-the-officer-package/
as an example to follow for this work

```{r cars}
library(officer)
library(dplyr)
# library(flextable) # make this work
```

Specs

```{r data frame for specs}
values <- c("_01", "1", "2", "2a", "2b", "2c", "3a", "3b", "3c", as.character(4:16))
descriptions <- c(
  "blue_header_container",
  "BGC",
  "all_english_names",
  rep("name", 3),
  rep("latin_name", 3),
  "header_02",
  "general_description",
  "small_logo_forest",
  "BGC_image",
  "header_02",
  "characteristic_vegetation",
  "header_02",
  "wetland_edatopic_grid",
  "header_02",
  "comments",
  "style_line",
  "page_number",
  "journal"
)
data_types <- c(
  "style",
  rep("string", 10),
  rep("image", 2),
  "string",
  "data_frame",
  "string",
  "possibly_ggplot",
  rep("string", 2),
  "style",
  "integer",
  "string"
)
is_style_feature_only_vector <- c(
  TRUE,
  rep(FALSE, 18),
  TRUE,
  rep(FALSE, 2)
)
my_specs <- data.frame(value = values, description = descriptions, data_type = data_types, is_style_feature_only = is_style_feature_only_vector)


```

```{r set up document}
my_doc <- read_docx()
styles_info(my_doc)

src_example <- tempfile(fileext = ".png")
png(filename = src_example, width = 5, height = 6, units = 'in', res = 300)
barplot(1:10, col = 1:10)
# dev.off()

ID <- "Wb01"
SPECIES <- "Black spruce - Creeping-snowberry - Peat-moss"
SPECIES_LATIN <- "Picea mariana - Gaultheria hispidula - Sphagnum"
HEADER_01 <- "General Description"
HEADER_02 <- "Characteristic Vegetation"
HEADER_03 <- "Wetland Edatopic Grid"
GENERAL_DESCRIPTION_TEXT <- "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec ut diam nec magna lacinia placerat. In condimentum metus in ex semper elementum. Suspendisse auctor, lacus sit amet placerat tempor, ex enim aliquet dui, quis dignissim nibh eros ac magna. Sed vulputate ornare est vitae pulvinar. Aliquam efficitur lectus augue, vel lobortis nibh suscipit ac. Nulla in placerat nunc. Duis nec metus eu velit efficitur maximus vitae lacinia quam."
THEME_COLOUR <- "#49bfee"

align_right <- fp_par(text.align = "right", padding = 0)
background_shading <- fp_par(padding = 0, shading.color = THEME_COLOUR)
text_style_normal <- fp_text(font.size = 12)
text_style_white <- fp_text(color = "white")
text_style_blue <- fp_text(color = THEME_COLOUR, bold = TRUE)

title_at_top <- block_list(
  fpar(ftext(ID, text_style_normal), " ",
       ftext(SPECIES, text_style_white), fp_p = background_shading))
my_doc <- body_add(my_doc, title_at_top)

general_header <- fpar(ftext(HEADER_01, text_style_blue))

my_doc <- my_doc %>% 
  body_add_par("", style = "Normal") %>% 
  body_add_par(SPECIES_LATIN) %>% 
  body_add_par("", style = "Normal") %>% 
  body_add_par("", style = "Normal") %>% 
  body_add(general_header) %>%
  body_add_par(GENERAL_DESCRIPTION_TEXT) %>%
  slip_in_img(src = "./histogram.png", width = 1, height = 1, pos = "before") %>% # height and width are in inches
  slip_in_img(src = "./histogram.png", width = 1, height = 1, pos = "after")




# maybe I can do something smart where I get the height of the image, and do a kind of absolute position or text align that wraps around that height, so the image is more seamless with the GENERAL_DESCRIPTION_TEXT


body_add_fpar(my_doc, fpar( ftext(HEADER_03, prop = text_style_normal), fp_p = align_right ))

remove("/reports/docx/first_example.docx")



print(my_doc, target = "./reports/docx/first_example.docx")


```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# create new word document
new.word.doc=function(){
  my.doc=read_docx()
  return(my.doc)
}


# import Word document in a data.frame
# The function docx_summary() reads and imports content of a Word document into a data.frame. The function handles paragraphs, tables and section breaks.


# add an empty line
add.empty.line=function(doc){
  body_add_par(doc, " ")
  return("empty line added")
}

#add page break
add.page.break=function(doc){
  body_add_break(doc, pos="after")
  return("page break added")
}

# start landscape
start.landscape=function(doc){
  doc=body_end_section_continuous(doc)
  return("landscape orientation started")
}

# end landscape
end.landscape=function(doc){
  doc=body_end_section_landscape(doc)
  return("landscape orientation ended")
}

# add a title
add.title=function(doc, my.title){
  my.prop=fp_text(font.size = 14, bold = TRUE, font.family = "Times")
  the.title=fpar(ftext(my.title, prop=my.prop))
  body_add_fpar(doc, the.title)
  body_add_par(doc, " ")
  return("title added")
}
# add an image, such as a jpg or png file
add.image=function(doc, image, h=5, w=5){
  body_add_img(doc, src=image,
               height=h, width=w,
               style="centered")
  return("image added")
}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r generate document}
# create an histogram and save it as a png file:
png(filename="histogram.png", width = 6, height = 6, units = 'in', res = 300)
hist(mtcars$wt)
dev.off()

# create a data frame that will become a table in my report
wide.table=mtcars[1:6, ]
wide.table$car=rownames(wide.table)
wide.table=wide.table[, c(12, 1:11)]
narrow.table=wide.table[, 1:4]

# create a new document object
doc=new.word.doc()

# add the report title and an empty line
add.title(doc, "My report")
add.empty.line(doc)

add.page.break(doc)

# add the histogram with an apropriate title
add.title(doc, "Histogram - portrait")
add.image(doc, "histogram.png", h=3, w=3)



# generate the Word document using the print function
print(doc, target="My report.docx")
```
